

**✅ 0. 기본 설명**

```
int sockfd = socket(AF_INET, SOCK_STREAM, 0);
```

• AF_INET: IPv4

• SOCK_STREAM: TCP

• 0: 자동으로 TCP 선택됨

  

이 코드는 **소켓을 생성**하고, **파일 디스크립터(sockfd)**를 반환합니다.

---

**✅ 1. 유저 공간에서 시스템 콜 진입**

  

**📌 소켓 API 호출**

```
socket(AF_INET, SOCK_STREAM, 0);
```

는 사실 glibc에서 제공하는 래퍼 함수이고, 내부적으로는 시스템 콜인 socket() 또는 socketcall을 호출합니다.

  

**🧠 실제 시스템 콜로 넘어감**

• x86_64에서는 socket()은 sys_socket()이라는 시스템 콜로 연결됨

• 시스템 콜 번호(__NR_socket)를 통해 커널에 전달됨

---

**✅ 2. 커널 공간 진입: 시스템 콜 처리 흐름**

  

**🔁 시스템 콜 처리 흐름 (리눅스 커널 내부)**

```
socket()
 └─> __sys_socket()
      └─> sock_create()
           └─> __sock_create()
                ├─> sock_alloc()
                ├─> sock->ops = &inet_stream_ops
                └─> sk = inet_create()
```

  

---

**✅ 3. 각 함수의 역할 (중요 함수 위주 정리)**

  

**✅ __sys_socket()**

• 커널 진입 후 첫 처리 함수

• 소켓의 도메인, 타입, 프로토콜을 검증

  

**✅ sock_create()**

• struct socket 구조체를 생성하고 초기화

  

**✅ __sock_create()**

• 내부적으로 socket->ops를 세팅

• TCP이면 inet_stream_ops 구조체 할당

• inet_create() 호출

  

**✅ inet_create()**

• TCP 소켓이라면 tcp_prot를 할당

• struct sock (전송 계층 제어 블록) 생성

• 프로토콜 별 초기화 수행 (예: tcp_init_sock())

  

**✅ sock_alloc()**

• 새로운 소켓 구조체 할당 (SLAB 메모리 캐시)

---

**✅ 4. 파일 디스크립터 할당**

  

마지막에:

```
fd = get_unused_fd_flags(flags);
fd_install(fd, file);  // struct file에 소켓 객체 연결
```

• 소켓은 결국 struct file로 표현됨

• 이 파일 구조체는 파일 디스크립터 테이블에 저장됨

---

**✅ 5. 최종적으로 사용자 공간으로 소켓 디스크립터 반환**

```
return fd;  // ex) 3, 4, 5 등 사용 가능한 디스크립터 번호
```

  

---

**🔎 전체 요약 흐름**

```
유저 공간
────────────
socket(AF_INET, SOCK_STREAM, 0)
   ↓
glibc → syscall

커널 공간
────────────
__sys_socket()
  → sock_create()
    → __sock_create()
      → sock_alloc()
      → inet_create()
         → tcp_prot 설정
         → sock 구조체 설정
      → socket->ops 설정
  → fd = get_unused_fd_flags()
  → fd_install(fd, file)
  → return fd
```

  

---

**📂 관련 커널 소스 파일 위치 (리눅스 소스 트리 기준)**

|**역할**|**파일**|
|---|---|
|__sys_socket()|net/socket.c|
|__sock_create()|net/socket.c|
|inet_create()|net/ipv4/af_inet.c|
|tcp_prot, tcp_init_sock()|net/ipv4/tcp.c|

  

---

**✅ 참고로 생성되는 주요 구조체들**

|**구조체**|**설명**|
|---|---|
|struct socket|소켓의 전반적인 정보|
|struct sock|프로토콜 관련 정보 (TCP/UDP 등)|
|struct file|파일 디스크립터와 연결된 커널 객체|
|inet_protosw, proto_ops|해당 소켓 타입에 따라 동작 정의|

  

---

이 내용을 기반으로 흐름도, 리포트, 실습 보고서 등을 만들 수 있어요.

필요하시면 다이어그램으로 그려드리거나, 요약 버전도 정리해드릴게요!