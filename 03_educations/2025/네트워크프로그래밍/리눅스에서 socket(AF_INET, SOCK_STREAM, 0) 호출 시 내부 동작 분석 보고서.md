
---

- ## 1. 개요
socket() 함수는 네트워크 통신을 위한 소켓을 생성하는 시스템 호출이다.
리눅스에서는 이 함수 호출 시 내부적으로 커널 영역의 여러 함수를 순차적으로 호출하여 소켓을 생성하고, 이 소켓을 제어할 수 있도록 파일 디스크립터(FD)를 반환한다.
본 보고서는 socket(AF_INET, SOCK_STREAM, 0) 함수 호출 시, 리눅스 커널에서 실제 어떤 sub 함수들이 어떤 순서로 호출되는지, 그리고 각 함수의 호출 목적과 역할에 대해 분석한다.

---
- ## 2. 함수 호출 흐름 및 호출 이유 
	- #### 1. socket()
		-  사용자 프로그램이 호출하는 표준 라이브러리 함수이다.
		- 내부적으로 시스템 콜을 발생시켜 커널에 소켓 생성 요청을 전달한다.
		-  이 호출은 시스템 콜 트랩을 통해 커널 모드로 진입하게 된다.
	- #### 2.  \_\_sys_socket()
		- 시스템 콜 진입점으로, 사용자 영역에서 커널 영역으로 전환된다.
		- 도메인(AF_INET), 타입(SOCK_STREAM), 프로토콜 인자의 유효성을 검사하고, 커널 내부의 소켓 생성 과정을 시작한다.
	- #### 3. sock_create()
		-  유효성 검사 후, 해당 네트워크 도메인(AF_INET)에 맞는 소켓 생성을 요청한다.
		 - 내부적으로 \_\_sock_create() 함수를 호출하여 구체적인 생성 로직을 위임한다.
	- #### 4. \_\_sock_create()
		-  실제 소켓을 생성하는 핵심 함수이다.
		- 이 함수는 다음과 같은 하위 함수들을 순차적으로 호출하여 소켓 구조체를 생성 및 초기화한다.
	- #### 5. sock_alloc()
		-  커널 메모리 공간(SLAB 캐시)에서 struct socket 객체를 동적으로 할당한다.
		- 이때 할당된 소켓은 아직 프로토콜 정보가 결합되지 않은 상태다.
	- #### 6.  inet_create()
		- net_families\[AF_INET]->create()를 통해 도메인에 맞는 생성 함수가 호출된다.
		- SOCK_STREAM 타입일 경우 TCP용 프로토콜 구조체인 tcp_prot를 할당한다.
		- 내부적으로 struct sock을 생성하고, TCP 관련 내부 상태, 큐 등을 초기화한다.
	- #### 7. sock_init_data()
		- 위에서 생성한 struct sock을 소켓에 연결하고 내부 필드를 초기화한다.
		- 수신 큐, 송신 큐, 타이머, 시퀀스 넘버 등의 TCP 통신에 필요한 요소들을 설정한다.
	- #### 8. sock->ops = &inet_stream_ops
		- 소켓 연산 함수 테이블을 설정한다.
		- send(), recv(), bind(), connect() 등의 함수 호출 시 이 테이블에 등록된 함수 포인터가 실행된다.
	- #### 9. security_socket_create()
		-  SELinux, AppArmor 등 리눅스 보안 모듈의 정책에 따라 소켓 생성이 허용되는지 확인한다.
		- 보안 정책에 위배되는 경우 소켓 생성이 차단될 수 있다.
	- #### 10.  sock_alloc_file()
		-  생성된 소켓을 파일처럼 다루기 위해 struct file 객체를 생성하고, 이를 소켓과 연결한다.
		- 이후 사용자에게 반환할 수 있는 형태로 소켓이 포장된다.
	- #### 11. get_unused_fd_flags() → fd_install()
		-  사용 가능한 파일 디스크립터 번호를 확보하고, 위에서 생성한 struct file을 해당 FD에 등록한다.
		-  최종적으로 소켓에 대한 파일 디스크립터가 사용자에게 반환되며, 이 값을 통해 read(), write() 등 다양한 연산이 가능해진다.
## 3. 함수호출흐름 요약

```
socket()                         // 사용자 공간에서 호출 : 소켓 생성 요청
 └─> __sys_socket()              // 커널 진입: 시스템 콜 핸들러
      └─> sock_create()          // 도메인/타입 기반 소켓 생성 요청
           └─> __sock_create()   // 실제 소켓 생성 로직
                ├─> sock_alloc()               // socket 구조체 메모리 할당
                ├─> inet_create()              // TCP/IP 기반 sock 구조체 생성
                │     └─> tcp_prot 설정        // TCP 동작 방식 등록
                │     └─> struct sock 연결     // 프로토콜 상태를 담는 구조체 할당후 연결
                └─> sock_init_data()          // 내부 수신/송신 큐 초기화
				└─> sock->ops설정     // 소켓 연산 함수 등록(read,write 등)

      └─> security_socket_create() // 보안 정책 검사 (SELinux 등)
      └─> sock_alloc_file()        // FD에 연결할 파일 구조체 생성
      └─> get_unused_fd_flags()    // 사용 가능한 파일 디스크립터 확보
      └─> fd_install()             // 소켓을 FD에 연결

리턴: 파일 디스크립터 (예: 3) //1과 2는 이미 사용되어져 보통 3 이상의 정수가 할당된다.

```


## 4. 결론
socket(AF_INET, SOCK_STREAM, 0) 함수는 단순한 사용자 API 호출처럼 보이지만, 내부적으로는 커널의 여러 서브 시스템이 연동되어 동작한다.  
특히 도메인(AF_INET), 타입(SOCK_STREAM), 프로토콜(0)에 따라 적절한 프로토콜 설정, (tcp_prot) 소켓 연산 설정 (inet_stream_ops), 보안 정책 적용 (security_socket_create), 파일 디스크립터 할당 (sock_alloc_file → fd_install) 등이 수행된다. 커널은 이 과정에서 보안 검사를 수행하고 사용자에게 파일 디스크립터를 반환함으로써 소켓 기반의 통신이 가능하도록 한다.